#!/usr/bin/env zsh
set -eu -o pipefail
zparseopts -D -E -F \
    -safe=OPT_SAFE \
    -help=OPT_HELP \
    -no-flush=OPT_NO_FLUSH \
    -settings:=OPT_SETTINGS
[[ -n $OPT_HELP ]] && cat <<EOF && exit 0
Flushes the local database and calls seed_cypress. This always uses the
Non-Dockerized Local DB setup.

Opts:
    --safe
        Fail if TCP connection test succeeds on port 5433 or 5434
EOF

if [[ -n $OPT_SAFE ]]; then
    if nc -z localhost 5433; then
        exit 1
    else
        [[ $? = 1 ]] || exit 1
    fi
    if nc -z localhost 5434; then
        exit 1
    else
        [[ $? = 1 ]] || exit 1
    fi
fi


export USE_NONDOCKERIZED_LOCAL_DB=True
export USE_PROD_DB=False
export DOCKER_TESTING_LOCAL_ES="${DOCKER_TESTING_LOCAL_ES:=True}"

if [[ -n $OPT_SETTINGS ]]; then
    SETTINGS="--settings=${OPT_SETTINGS[2]}"
else
    SETTINGS=""
fi

if [[ -z $OPT_NO_FLUSH ]]; then
    (set -x; python manage.py flush --no-input $SETTINGS --use_nondockerized_local_db)
fi
(set -x; python manage.py seed_cypress $SETTINGS --use_nondockerized_local_db)
