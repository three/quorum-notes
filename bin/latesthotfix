#!/usr/bin/env zsh
set -eu -o pipefail

zparseopts -help=HELP -fetch=OPT_FETCH -prefer-system=OPT_SYSGREP
[[ -n $HELP ]] && cat <<EOF && exit 0 || true
Usage: latesthotfix [--help]

Find and print the version number of the largest remote
hotfix branch. For instance, if you wanted to checkout the
latest hotfix branch you could do,

    $ git fetch
    $ git checkout "hotfix/\$(latesthotfix)"

Options:

    --help
        Print this message
    --fetch
        Run "git fetch" first
    --prefer-system
        Prefer system grep (by default, use ggrep if it exists)
EOF

if [[ -z $OPT_SYSGREP ]] && whence -p ggrep >/dev/null 2>&1; then
    alias grep=ggrep
fi

if [[ -n $OPT_FETCH ]]; then
    git fetch -q
fi

git branch -a | \
    grep 'remotes/origin/hotfix' | \
    grep -Eo '[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+' | \
    sort -rV |
    head -n 1
