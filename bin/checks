#!/usr/bin/env zsh

# Bash Boilerplate Checks
set -o errexit
set -o pipefail

source "$QUORUM_TOOLS_DIR/quorum.sh"

echo "Ensuring the environment has node..."
(which node >/dev/null && node --version) || {
    NVM_DIRECTORY="$DOTFILES/deps/nvm"
    source "$NVM_DIRECTORY/nvm.sh"
    nvm use node
}
echo

echo "Loading virtualenv..."
source "$QUORUM_ROOT/venv/bin/activate"
export PYTHONPATH="$(pwd)"
echo

echo "Detecting if the environment has darker..."
which darker >/dev/null && {
    darker --version
    export USE_DARKER=1
} || echo "Darker not detected. USE_DARKER=${USE_DARKER:-unset}"
echo

echo "Searching for files to check..."
COMMON_ANCESTOR="$(git merge-base HEAD origin/hotfix/$(latesthotfix))"
echo "Common Ancestor: $COMMON_ANCESTOR"
ALTERED_FILES="$(git diff --name-only $COMMON_ANCESTOR)"
[[ -z "$ALTERED_FILES" ]] && (
    echo "No files to check!"
    return 0
)
echo

RETURN_CODE=0
(echo "$ALTERED_FILES" | xargs python tests/check/__main__.py) || {
    RETURN_CODE="$?"
}

echo "Checking darker..."
if which darker >/dev/null
then
    echo "Darker Version: $(darker --version)"
    if darker --check -r "$(hotfix)" --line-length 120 .
    then
        echo "Passed"
    else
        echo "Darker returned $?"
        [[ "$RETURN_CODE" == 0 ]] && RETURN_CODE = 1
    fi
else
    echo "Darker not in your PATH, skipping"
fi
echo

echo "Exit Status $RETURN_CODE"
return $?

